# Data Model - Deploy to GitHub Pages

**Feature**: 002-deploy-to-gh | **Date**: 2025-10-06

## Overview

This feature deals with CI/CD workflow data structures rather than traditional application data models. The "entities" are configuration structures, API payloads, and workflow artifacts.

## Workflow Data Structures

### 1. Version Tag

**Format**: `pages/vX.Y.Z`
**Pattern**: `pages/v*` (glob pattern for filtering)
**Components**:

- Prefix: `pages/v` (fixed)
- Major: X (integer)
- Minor: Y (integer)
- Patch: Z (integer)

**Validation Rules**:

- MUST match pattern `^pages/v\d+\.\d+\.\d+$`
- MUST be a valid git tag
- Version components MUST be non-negative integers

**State Transitions**:

1. Created locally: `git tag pages/vX.Y.Z`
2. Pushed to remote: `git push origin pages/vX.Y.Z`
3. Triggers workflow: GitHub Actions detects tag push
4. Archived in release: GitHub Release created with same tag

**Example**: `pages/v0.1.0`, `pages/v1.2.3`

### 2. Package Version

**Format**: Semantic version string in package.json
**Components**:

- Major.Minor.Patch (release): `1.2.3`
- Major.Minor.Patch-dev (development): `1.2.4-dev`

**Validation Rules**:

- MUST follow semantic versioning spec
- Development versions MUST use `-dev` suffix
- MUST match version extracted from git tag during release

**State Transitions**:

1. Development: `1.2.4-dev` (between releases)
2. Pre-build: Set to `1.2.3` (extracted from tag `pages/v1.2.3`)
3. Build: Used in artifact metadata
4. Post-release: Bumped to `1.2.4-dev` (next development cycle)

### 3. GitHub Release

**Structure**:

```json
{
  "tag_name": "pages/v1.2.3",
  "name": "Bodhi Chat v1.2.3",
  "body": "Bodhi Chat Release v1.2.3\n\nDeployed to GitHub Pages: https://bodhiapps.github.io/bodhichat",
  "draft": false,
  "prerelease": false,
  "created_at": "2025-10-06T12:00:00Z",
  "assets": [
    {
      "name": "index.html",
      "browser_download_url": "https://github.com/bodhiapps/bodhichat/releases/download/pages/v1.2.3/index.html"
    }
  ]
}
```

**Relationships**:

- One-to-one with Version Tag (same tag_name)
- One-to-many with Release Assets (dist/ files)

**Validation Rules**:

- tag_name MUST match `pages/v*` pattern
- MUST have at least one asset from dist/ directory
- draft MUST be false (published immediately)
- prerelease MUST be false (production releases only)

### 4. Production Artifact

**Location**: `dist/` directory (generated by Vite build)
**Contents**:

- index.html (entry point)
- assets/ (JS, CSS, images, fonts)
- Any static resources

**Validation Rules**:

- dist/ directory MUST exist after build step
- index.html MUST be present
- Assets MUST have valid paths referenced in HTML

**State Transitions**:

1. Generated: `npm run build` creates dist/
2. Uploaded for Pages: actions/upload-pages-artifact
3. Deployed to Pages: actions/deploy-pages
4. Archived in Release: softprops/action-gh-release

**Relationships**:

- Many-to-one with GitHub Release (multiple files per release)
- Many-to-one with Version Tag (artifacts belong to specific version)

### 5. GitHub API Release Response

**Fetched By**: Makefile via `gh api repos/bodhiapps/bodhichat/releases`
**Filtered**: Only releases with `tag_name` starting with `pages/v`
**Sorted**: By `created_at` descending
**Used For**: Determining next version number

**Structure** (filtered):

```json
[
  {
    "tag_name": "pages/v1.2.3",
    "created_at": "2025-10-06T12:00:00Z"
  },
  {
    "tag_name": "pages/v1.2.2",
    "created_at": "2025-10-05T12:00:00Z"
  }
]
```

**Validation Rules**:

- Response MUST be valid JSON array
- Each item MUST have tag_name and created_at fields
- Empty array is valid (first release)

### 6. Workflow Configuration

**File**: `.github/workflows/deploy-pages.yml`
**Key Fields**:

```yaml
on:
  push:
    tags:
      - 'pages/v*'

concurrency:
  group: pages-deployment-${{ github.ref }}
  cancel-in-progress: false

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions:
  contents: write # For creating releases
  pages: write # For deploying to Pages
  id-token: write # For Pages deployment attestation
```

**Validation Rules**:

- MUST trigger only on tags matching `pages/v*`
- MUST have appropriate permissions for Pages and releases
- MUST configure concurrency control

### 7. Makefile Environment Variables

**Input Variables**:

- `GH_PAT` (optional): GitHub Personal Access Token for API operations
  - Type: String
  - Format: `gh_pat_[A-Za-z0-9]+`
  - Used for: Avoiding rate limits on GitHub API calls
  - Default: None (uses unauthenticated requests)

**Validation Rules**:

- If provided, MUST be valid GitHub token format
- Token MUST have `repo` and `read:packages` scopes (for release operations)

### 8. Git Repository State

**Required State Before Tag Creation**:

```
Clean working directory:
- No uncommitted changes
- No untracked files (that matter)
- No unpushed commits

Current branch:
- MUST be main (or master)

Remote sync:
- Local branch MUST be up-to-date with remote
```

**Validation Commands**:

- `git status --porcelain` - MUST return empty
- `git rev-parse --abbrev-ref HEAD` - MUST return main
- `git rev-list @{u}..HEAD` - MUST return empty (no unpushed commits)

## Data Flow

```
Developer invokes: make release.pages [GH_PAT=token]
    ↓
Makefile fetches: GitHub Releases API → Release list
    ↓
Makefile filters: tag_name matches "pages/v*"
    ↓
Makefile sorts: By created_at descending
    ↓
Makefile extracts: Latest version (e.g., 1.2.3)
    ↓
Makefile calculates: Next version (e.g., 1.2.4)
    ↓
Makefile validates: Git repository state
    ↓
Makefile checks: Tag existence (local and remote)
    ↓
[If tag exists]: Prompt user for overwrite confirmation
    ↓
Makefile creates: Git tag "pages/v1.2.4"
    ↓
Makefile pushes: Tag to remote
    ↓
GitHub detects: Tag push matching "pages/v*"
    ↓
Workflow extracts: Version from tag (1.2.4)
    ↓
Workflow updates: package.json version via npm
    ↓
Workflow builds: Production artifacts → dist/
    ↓
Workflow deploys: dist/ to GitHub Pages
    ↓
Workflow creates: GitHub Release with artifacts
    ↓
Workflow calculates: Next dev version (1.2.5-dev)
    ↓
Workflow updates: package.json version
    ↓
Workflow commits: Version bump to main branch
```

## Error States

### Makefile Error States

1. **Git Not Clean**: `git status` returns uncommitted changes
   - Error: "Uncommitted changes detected. Commit or stash before release."
   - Recovery: Commit or stash changes

2. **Git Not Synced**: Local behind or ahead of remote
   - Error: "Local branch not synced with remote. Pull/push before release."
   - Recovery: `git pull` then `git push`

3. **GitHub API Error**: API request fails (rate limit, network, auth)
   - Error: "GitHub API request failed: {reason}. Provide GH_PAT if rate limited."
   - Recovery: Provide GH_PAT or wait for rate limit reset

4. **Tag Already Exists**: Tag exists locally or remotely
   - Prompt: "Tag pages/vX.Y.Z already exists. Delete and recreate? (y/N)"
   - If N: Abort release
   - If Y: Delete local and remote tags, recreate

### Workflow Error States

1. **Build Failure**: `npm run build` fails
   - Status: Workflow fails immediately
   - Recovery: Fix build error, create new tag

2. **Pages Deployment Failure**: `actions/deploy-pages` fails
   - Status: Workflow fails, release step may succeed
   - Recovery: Manual Pages deployment or new tag

3. **Release Creation Failure**: `softprops/action-gh-release` fails
   - Status: Workflow fails, Pages deployment may succeed
   - Recovery: Manual release creation or new tag

4. **Network Failure**: Transient network error
   - Retry: Automatic retry (3 attempts @ 500ms)
   - Recovery: If all retries fail, workflow fails

## Constraints

1. **GitHub API Rate Limits**:
   - Unauthenticated: 60 requests/hour
   - Authenticated (GH_PAT): 5000 requests/hour
   - Mitigation: Provide GH_PAT for releases

2. **Concurrency**:
   - Only one deployment per tag reference
   - Simultaneous deployments for different tags allowed
   - Queue-based processing for same tag

3. **Version Monotonicity**:
   - Version numbers SHOULD increase monotonically
   - Patch version auto-incremented
   - Manual major/minor bumps require override

4. **Artifact Size**:
   - GitHub Pages: 1GB size limit
   - GitHub Release assets: 2GB per file, 2GB total
   - Expected dist/ size: < 10MB (well within limits)

## Dependencies

### External Services

- GitHub API (api.github.com)
- GitHub Pages (github.io domain)
- npm registry (registry.npmjs.org) - for npm version command

### GitHub Actions

- actions/checkout@v4
- actions/setup-node@v4
- actions/configure-pages@v4
- actions/upload-pages-artifact@v3
- actions/deploy-pages@v4
- softprops/action-gh-release@v1
- nick-fields/retry@v2 (for retry logic)

### CLI Tools

- git (version control)
- gh (GitHub CLI)
- npm (package management)
- jq (JSON processing in Makefile)
- make (build automation)
